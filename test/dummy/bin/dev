#!/usr/bin/env bash

# Rails Pulse Development Server
# Builds assets and starts the Rails server

set -e

echo "🚀 Starting Rails Pulse development server..."

# Save the dummy app directory
DUMMY_DIR="$(pwd)"

# Change to the Rails Pulse root directory (parent of test/dummy)
cd "$(dirname "$0")/../.."

# Check if npm is available
if ! command -v npm &> /dev/null; then
  echo "❌ npm is required but not installed. Please install Node.js and npm."
  exit 1
fi

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
  echo "📦 Installing npm dependencies..."
  npm install
fi

# Start asset watching in background
echo "👀 Starting asset watcher..."
npm run watch &
WATCH_PID=$!

# Function to cleanup background processes
cleanup() {
  echo "🛑 Stopping asset watcher..."
  kill $WATCH_PID 2>/dev/null || true
  exit
}

# Trap cleanup on script exit
trap cleanup EXIT INT TERM

# Initial build
echo "🔨 Building Rails Pulse assets..."
npm run build

# Detect database adapter
cd "$DUMMY_DIR"
DB=${DB:-$(./bin/rails runner "puts ActiveRecord::Base.connection.adapter_name" 2>/dev/null || echo "sqlite3")}

# Display database adapter info
case "$DB" in
  "SQLite")
    echo "🗂️  Database: SQLite"
    ;;
  "PostgreSQL"|"postgresql")
    echo "🐘 Database: PostgreSQL"
    ;;
  "MySQL"|"Mysql2"|"mysql2")
    echo "🐬 Database: MySQL"
    ;;
  *)
    echo "🗄️  Database: $DB"
    ;;
esac

# Start the Rails server from the dummy app directory
echo "🌐 Starting Rails server..."
exec ./bin/rails server "$@"
