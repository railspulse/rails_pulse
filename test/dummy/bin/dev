#!/usr/bin/env bash

# Rails Pulse Development Server
# Builds assets and starts the Rails server

set -e

echo "ğŸš€ Starting Rails Pulse development server..."

# Save the dummy app directory
DUMMY_DIR="$(pwd)"

# Change to the Rails Pulse root directory (parent of test/dummy)
cd "$(dirname "$0")/../.."

# Check if npm is available
if ! command -v npm &> /dev/null; then
  echo "âŒ npm is required but not installed. Please install Node.js and npm."
  exit 1
fi

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
  echo "ğŸ“¦ Installing npm dependencies..."
  npm install
fi

# Start asset watching in background
echo "ğŸ‘€ Starting asset watcher..."
npm run watch &
WATCH_PID=$!

# Function to cleanup background processes
cleanup() {
  echo "ğŸ›‘ Stopping asset watcher..."
  kill $WATCH_PID 2>/dev/null || true
  exit
}

# Trap cleanup on script exit
trap cleanup EXIT INT TERM

# Initial build
echo "ğŸ”¨ Building Rails Pulse assets..."
npm run build

# Detect database adapter
cd "$DUMMY_DIR"
DATABASE_ADAPTER=${DATABASE_ADAPTER:-$(./bin/rails runner "puts ActiveRecord::Base.connection.adapter_name" 2>/dev/null || echo "sqlite3")}

# Display database adapter info
case "$DATABASE_ADAPTER" in
  "SQLite")
    echo "ğŸ—‚ï¸  Database: SQLite"
    ;;
  "PostgreSQL"|"postgresql")
    echo "ğŸ˜ Database: PostgreSQL"
    ;;
  "MySQL"|"Mysql2"|"mysql2")
    echo "ğŸ¬ Database: MySQL"
    ;;
  *)
    echo "ğŸ—„ï¸  Database: $DATABASE_ADAPTER"
    ;;
esac

# Start the Rails server from the dummy app directory
echo "ğŸŒ Starting Rails server..."
exec ./bin/rails server "$@"
